---
name: Terraform Create Repository

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "New repository name"
        required: true
        type: string
      repo_owner:
        description: "Repository owner (user/org)"
        required: false
        type: string
      repo_description:
        description: "Repository description"
        required: false
        default: "Repository following SOLID principles and best practices"
        type: string
      visibility:
        description: "Repository visibility"
        required: false
        default: "public"
        type: choice
        options:
          - public
          - private
          - internal
      cleanup_on_failure:
        description: "Destroy Terraform resources if workflow fails"
        required: false
        default: true
        type: boolean
      enable_branch_protection:
        description: "Enable branch protection rules"
        required: false
        default: true
        type: boolean
      team_name:
        description: "GitHub team for code owners (e.g., team-leads)"
        required: false
        default: "team-leads"
        type: string
      license_holder:
        description: "License copyright holder name"
        required: false
        type: string
      languages:
        description: "Programming languages (comma-separated: javascript,typescript,python or 'all' for monorepo)"
        required: false
        default: "language-agnostic-only"
        type: string

jobs:
  terraform-create-repository:
    name: Terraform Create Repository
    runs-on: ubuntu-latest
    outputs:
      owner: ${{ steps.set-owner.outputs.owner }}
      repo_created: ${{ steps.terraform-apply.outputs.repo_created }}
    permissions:
      contents: write
      id-token: write
      actions: write

    steps:
      - name: Checkout bootstrap repository
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.5"
          terraform_wrapper: false

      - name: Set repository owner
        id: set-owner
        run: |
          if [ -z "${{ github.event.inputs.repo_owner }}" ]; then
            echo "owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          else
            echo "owner=${{ github.event.inputs.repo_owner }}" >> $GITHUB_OUTPUT
          fi

      - name: Set license holder
        id: set-license
        run: |
          if [ -z "${{ github.event.inputs.license_holder }}" ]; then
            echo "holder=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          else
            echo "holder=${{ github.event.inputs.license_holder }}" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Init
        working-directory: terraform
        env:
          TF_VAR_github_token: ${{ secrets.GH_PAT }}
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_VAR_github_token: ${{ secrets.GH_PAT }}
          TF_VAR_repo_name: ${{ github.event.inputs.repo_name }}
          TF_VAR_repo_owner: ${{ steps.set-owner.outputs.owner }}
          TF_VAR_repo_description: ${{ github.event.inputs.repo_description }}
          TF_VAR_visibility: ${{ github.event.inputs.visibility }}
          TF_VAR_enable_branch_protection: ${{ github.event.inputs.enable_branch_protection }}
          TF_VAR_team_name: ${{ github.event.inputs.team_name }}
          TF_VAR_license_holder: ${{ steps.set-license.outputs.holder }}
          TF_VAR_languages: ${{ github.event.inputs.languages }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: terraform-apply
        working-directory: terraform
        env:
          TF_VAR_github_token: ${{ secrets.GH_PAT }}
          TF_VAR_repo_name: ${{ github.event.inputs.repo_name }}
          TF_VAR_repo_owner: ${{ steps.set-owner.outputs.owner }}
          TF_VAR_repo_description: ${{ github.event.inputs.repo_description }}
          TF_VAR_visibility: ${{ github.event.inputs.visibility }}
          TF_VAR_enable_branch_protection: ${{ github.event.inputs.enable_branch_protection }}
          TF_VAR_team_name: ${{ github.event.inputs.team_name }}
          TF_VAR_license_holder: ${{ steps.set-license.outputs.holder }}
          TF_VAR_languages: ${{ github.event.inputs.languages }}
        run: |
          terraform apply -auto-approve tfplan
          echo "repo_created=true" >> $GITHUB_OUTPUT

      - name: Wait for repository initialization
        run: sleep 5

      - name: Clone new repository
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/${{ steps.set-owner.outputs.owner }}/${{ github.event.inputs.repo_name }}.git new-repo
          cd new-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Copy template files
        run: |
          cp -r templates/* new-repo/
          cp -r templates/.github new-repo/
          cp templates/.gitignore new-repo/
          cp templates/.gitattributes new-repo/
          cp templates/.super-linter.env new-repo/
          cp templates/.github/linters/.editorconfig new-repo/

      - name: Update CODEOWNERS with team name
        run: |
          cd new-repo
          sed -i "s/team-leads/${{ github.event.inputs.team_name }}/g" .github/CODEOWNERS

      - name: Update LICENSE with current year and holder
        run: |
          cd new-repo
          CURRENT_YEAR=$(date +%Y)
          sed -i "s/\[year\]/$CURRENT_YEAR/g" LICENSE
          sed -i "s/\[fullname\]/${{ steps.set-license.outputs.holder }}/g" LICENSE

      - name: Update README with repository details
        run: |
          cd new-repo
          sed -i "s/{{REPOSITORY_OWNER}}/${{ steps.set-owner.outputs.owner }}/g" README.md
          sed -i "s/{{REPOSITORY_NAME}}/${{ github.event.inputs.repo_name }}/g" README.md

      - name: Configure super-linter for selected languages
        run: |
          cd new-repo
          LANGUAGES="${{ github.event.inputs.languages }}"

          enable_language() {
            local lang=$1
            case "$lang" in
              "javascript")
                sed -i "s/# VALIDATE_JAVASCRIPT_ES=true/VALIDATE_JAVASCRIPT_ES=true/g" .super-linter.env
                sed -i "s/# VALIDATE_JAVASCRIPT_PRETTIER=true/VALIDATE_JAVASCRIPT_PRETTIER=true/g" .super-linter.env
                sed -i "s/# VALIDATE_JSX=true/VALIDATE_JSX=true/g" .super-linter.env
                sed -i "s/# VALIDATE_JSX_PRETTIER=true/VALIDATE_JSX_PRETTIER=true/g" .super-linter.env
                sed -i "s/# FIX_JAVASCRIPT_ES=true/FIX_JAVASCRIPT_ES=true/g" .super-linter.env
                sed -i "s/# FIX_JAVASCRIPT_PRETTIER=true/FIX_JAVASCRIPT_PRETTIER=true/g" .super-linter.env
                sed -i "s/# FIX_JSX=true/FIX_JSX=true/g" .super-linter.env
                sed -i "s/# FIX_JSX_PRETTIER=true/FIX_JSX_PRETTIER=true/g" .super-linter.env
                ;;
              "typescript")
                sed -i "s/# VALIDATE_TYPESCRIPT_ES=true/VALIDATE_TYPESCRIPT_ES=true/g" .super-linter.env
                sed -i "s/# VALIDATE_TYPESCRIPT_PRETTIER=true/VALIDATE_TYPESCRIPT_PRETTIER=true/g" .super-linter.env
                sed -i "s/# VALIDATE_TSX=true/VALIDATE_TSX=true/g" .super-linter.env
                sed -i "s/# FIX_TYPESCRIPT_ES=true/FIX_TYPESCRIPT_ES=true/g" .super-linter.env
                sed -i "s/# FIX_TYPESCRIPT_PRETTIER=true/FIX_TYPESCRIPT_PRETTIER=true/g" .super-linter.env
                sed -i "s/# FIX_TSX=true/FIX_TSX=true/g" .super-linter.env
                ;;
              "python")
                sed -i "s/# VALIDATE_PYTHON_RUFF=true/VALIDATE_PYTHON_RUFF=true/g" .super-linter.env
                sed -i "s/# VALIDATE_PYTHON_RUFF_FORMAT=true/VALIDATE_PYTHON_RUFF_FORMAT=true/g" .super-linter.env
                sed -i "s/# VALIDATE_PYTHON_MYPY=true/VALIDATE_PYTHON_MYPY=true/g" .super-linter.env
                sed -i "s/# FIX_PYTHON_RUFF=true/FIX_PYTHON_RUFF=true/g" .super-linter.env
                sed -i "s/# FIX_PYTHON_RUFF_FORMAT=true/FIX_PYTHON_RUFF_FORMAT=true/g" .super-linter.env
                ;;
              "java")
                sed -i "s/# VALIDATE_JAVA=true/VALIDATE_JAVA=true/g" .super-linter.env
                sed -i "s/# VALIDATE_GOOGLE_JAVA_FORMAT=true/VALIDATE_GOOGLE_JAVA_FORMAT=true/g" .super-linter.env
                sed -i "s/# FIX_GOOGLE_JAVA_FORMAT=true/FIX_GOOGLE_JAVA_FORMAT=true/g" .super-linter.env
                ;;
              "go")
                sed -i "s/# VALIDATE_GO=true/VALIDATE_GO=true/g" .super-linter.env
                sed -i "s/# VALIDATE_GO_MODULES=true/VALIDATE_GO_MODULES=true/g" .super-linter.env
                sed -i "s/# FIX_GO_MODULES=true/FIX_GO_MODULES=true/g" .super-linter.env
                ;;
              "rust")
                sed -i "s/# VALIDATE_RUST_2021=true/VALIDATE_RUST_2021=true/g" .super-linter.env
                sed -i "s/# VALIDATE_RUST_CLIPPY=true/VALIDATE_RUST_CLIPPY=true/g" .super-linter.env
                sed -i "s/# FIX_RUST_2021=true/FIX_RUST_2021=true/g" .super-linter.env
                sed -i "s/# FIX_RUST_CLIPPY=true/FIX_RUST_CLIPPY=true/g" .super-linter.env
                ;;
              "ruby")
                sed -i "s/# VALIDATE_RUBY=true/VALIDATE_RUBY=true/g" .super-linter.env
                sed -i "s/# FIX_RUBY=true/FIX_RUBY=true/g" .super-linter.env
                ;;
              "php")
                sed -i "s/# VALIDATE_PHP_BUILTIN=true/VALIDATE_PHP_BUILTIN=true/g" .super-linter.env
                sed -i "s/# VALIDATE_PHP_PHPCS=true/VALIDATE_PHP_PHPCS=true/g" .super-linter.env
                sed -i "s/# FIX_PHP_PHPCS=true/FIX_PHP_PHPCS=true/g" .super-linter.env
                ;;
              "csharp")
                sed -i "s/# VALIDATE_CSHARP=true/VALIDATE_CSHARP=true/g" .super-linter.env
                sed -i "s/# FIX_CSHARP=true/FIX_CSHARP=true/g" .super-linter.env
                ;;
              "cpp")
                sed -i "s/# VALIDATE_CPP=true/VALIDATE_CPP=true/g" .super-linter.env
                sed -i "s/# VALIDATE_CLANG_FORMAT=true/VALIDATE_CLANG_FORMAT=true/g" .super-linter.env
                sed -i "s/# FIX_CLANG_FORMAT=true/FIX_CLANG_FORMAT=true/g" .super-linter.env
                ;;
              "css")
                sed -i "s/# VALIDATE_CSS=true/VALIDATE_CSS=true/g" .super-linter.env
                sed -i "s/# VALIDATE_CSS_PRETTIER=true/VALIDATE_CSS_PRETTIER=true/g" .super-linter.env
                sed -i "s/# FIX_CSS_PRETTIER=true/FIX_CSS_PRETTIER=true/g" .super-linter.env
                ;;
              "html")
                sed -i "s/# VALIDATE_HTML=true/VALIDATE_HTML=true/g" .super-linter.env
                sed -i "s/# VALIDATE_HTML_PRETTIER=true/VALIDATE_HTML_PRETTIER=true/g" .super-linter.env
                sed -i "s/# FIX_HTML_PRETTIER=true/FIX_HTML_PRETTIER=true/g" .super-linter.env
                ;;
              "docker")
                sed -i "s/# VALIDATE_DOCKERFILE_HADOLINT=true/VALIDATE_DOCKERFILE_HADOLINT=true/g" .super-linter.env
                ;;
              "terraform")
                sed -i "s/# VALIDATE_TERRAFORM_FMT=true/VALIDATE_TERRAFORM_FMT=true/g" .super-linter.env
                sed -i "s/# VALIDATE_TERRAFORM_TFLINT=true/VALIDATE_TERRAFORM_TFLINT=true/g" .super-linter.env
                sed -i "s/# FIX_TERRAFORM_FMT=true/FIX_TERRAFORM_FMT=true/g" .super-linter.env
                ;;
              "kotlin")
                sed -i "s/# VALIDATE_KOTLIN=true/VALIDATE_KOTLIN=true/g" .super-linter.env
                ;;
              *)
                echo "Warning: Unknown language '$lang' - skipping"
                ;;
            esac
          }

          if [ "$LANGUAGES" = "all" ]; then
            enable_language "javascript"
            enable_language "typescript"
            enable_language "python"
            enable_language "java"
            enable_language "go"
            enable_language "rust"
            enable_language "ruby"
            enable_language "php"
            enable_language "csharp"
            enable_language "cpp"
            echo "Enabled all major languages" >> $GITHUB_STEP_SUMMARY
          elif [ "$LANGUAGES" = "language-agnostic-only" ]; then
            echo "Using language-agnostic linters only" >> $GITHUB_STEP_SUMMARY
          else
            IFS=',' read -ra LANG_ARRAY <<< "$LANGUAGES"
            for lang in "${LANG_ARRAY[@]}"; do
              lang=$(echo "$lang" | xargs)
              enable_language "$lang"
              echo "Enabled language: $lang" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Commit and push files
        id: push-files
        run: |
          cd new-repo
          git add .
          git commit -m "chore: initialize repository from bootstrap template"
          git push
          echo "âœ… Template files pushed" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "âœ… Repository created successfully via Terraform!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/${{ steps.set-owner.outputs.owner }}/${{ github.event.inputs.repo_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Visibility:** ${{ github.event.inputs.visibility }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Protection:** ${{ github.event.inputs.enable_branch_protection }}" >> $GITHUB_STEP_SUMMARY
          echo "**Languages:** ${{ github.event.inputs.languages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Created Resources (via Terraform)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub repository" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Repository settings (squash merge, auto-delete branches)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development environment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production environment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch protection ruleset" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Created Resources (via Template)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CODEOWNERS" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependabot configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .editorconfig (4 spaces code, 2 spaces config)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .gitignore, .gitattributes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation templates" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LICENSE (MIT)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Super-Linter workflow (auto-fix on PRs)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Super-Linter configuration (.super-linter.env)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Makefile (run 'make lint' locally)" >> $GITHUB_STEP_SUMMARY

  teardown:
    name: Terraform Destroy on Failure
    runs-on: ubuntu-latest
    needs: terraform-create-repository
    if: >-
      always() &&
      needs.terraform-create-repository.outputs.repo_created == 'true' &&
      needs.terraform-create-repository.result == 'failure' &&
      github.event.inputs.cleanup_on_failure == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout bootstrap repository
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.5"
          terraform_wrapper: false

      - name: Set repository owner
        id: set-owner
        run: |
          if [ -z "${{ github.event.inputs.repo_owner }}" ]; then
            echo "owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          else
            echo "owner=${{ github.event.inputs.repo_owner }}" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Init
        working-directory: terraform
        env:
          TF_VAR_github_token: ${{ secrets.GH_PAT }}
        run: terraform init

      - name: Terraform Destroy
        working-directory: terraform
        env:
          TF_VAR_github_token: ${{ secrets.GH_PAT }}
          TF_VAR_repo_name: ${{ github.event.inputs.repo_name }}
          TF_VAR_repo_owner: ${{ steps.set-owner.outputs.owner }}
          TF_VAR_repo_description: ${{ github.event.inputs.repo_description }}
          TF_VAR_visibility: ${{ github.event.inputs.visibility }}
          TF_VAR_enable_branch_protection: ${{ github.event.inputs.enable_branch_protection }}
          TF_VAR_team_name: ${{ github.event.inputs.team_name }}
          TF_VAR_license_holder: ${{ github.repository_owner }}
          TF_VAR_languages: ${{ github.event.inputs.languages }}
        run: |
          terraform destroy -auto-approve || true
          echo "ðŸ—‘ï¸ Repository destroyed via Terraform" >> $GITHUB_STEP_SUMMARY
